<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pink Sky Checker</title>
<meta name="description" content="Quickly tells you whether a chosen day's sunset in your area has the right clouds & air for vivid pink/blue afterglow." />
<meta name="theme-color" content="#f7e8f6">

<style>
  /* --- layout & typography --- */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#071425}
  :root{
    --pad: clamp(16px,4.2vw,36px);
    --bg-top:#f4f9ff; --bg-bottom:#fff6fb; --card:#ffffff; --muted:#6b7280;
    --pink:#ff78b6; --purple:#b08bff; --blue:#6e9bff;
    --radius:16px;
    --title-min:28px; --title-max:44px;
  }
  body{
    background: linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
    padding-top: calc(var(--pad) + env(safe-area-inset-top, 0px));
    padding-bottom: calc(var(--pad) + env(safe-area-inset-bottom, 0px));
    padding-left: calc(var(--pad) + env(safe-area-inset-left, 0px));
    padding-right: calc(var(--pad) + env(safe-area-inset-right, 0px));
    -webkit-font-smoothing:antialiased;
  }

  .wrap{max-width:980px;margin:0 auto}
  /* Title above card (big, gradient text) */
  .title {
    display:inline-block;margin-bottom:18px;padding:12px 20px;border-radius:30px;
    font-weight:900;
    font-size: clamp(var(--title-min), 6.5vw, var(--title-max));
    color:transparent; -webkit-background-clip:text;
    background-image: linear-gradient(90deg,var(--pink),var(--purple),var(--blue));
    text-shadow: 0 6px 20px rgba(107,119,255,0.06);
  }

  /* Card */
  .card{
    background:var(--card);
    border-radius:calc(var(--radius) + 2px);
    padding:18px;
    box-shadow: 0 18px 40px rgba(8,18,40,0.08);
    border:1px solid rgba(8,15,40,0.04);
  }
  .lead{color:var(--muted);margin-bottom:12px;font-size:15px}

  label{display:block;margin:8px 0 6px;font-weight:800;color:#051026}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .controls.col{flex-direction:column;align-items:stretch}
  input,select{padding:12px;border-radius:12px;border:1px solid rgba(8,15,40,0.06);font-size:16px;min-height:46px}
  input::placeholder{color:#a8b0bc}

  /* Gradient buttons */
  .btn{
    background: linear-gradient(90deg,var(--pink),var(--purple),var(--blue));
    color:white;border:0;padding:14px 18px;border-radius:14px;font-weight:800;cursor:pointer;
    box-shadow: 0 8px 22px rgba(107,119,255,0.08);min-height:46px;font-size:16px;
  }
  .btn.large{width:100%}

  /* Results */
  .result{margin-top:18px;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(245,251,255,0.98), rgba(255,248,252,0.98));border:1px solid rgba(99,102,241,0.04)}
  .score-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .score-left{min-width:0}
  .score-title{font-weight:900;font-size:20px;margin-bottom:6px}
  .verdict{font-weight:800;color:#243046;margin-bottom:8px}
  .tagline{color:var(--muted);margin-bottom:8px}
  .details{color:var(--muted);margin-top:6px}

  .pill{display:inline-block;padding:.42rem .66rem;border-radius:999px;color:white;font-weight:900;background:var(--pink);min-width:42px;text-align:center;box-shadow:0 8px 20px rgba(110,155,255,0.12);font-size:16px}

  .tips{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,244,248,0.85), rgba(237,245,255,0.85));border:1px solid rgba(107,119,255,0.04);font-size:15px;color:#243046}

  footer{margin-top:26px;text-align:center;color:var(--muted);font-size:14px}

  /* small screens: stack controls */
  @media (max-width:720px){
    .controls{flex-direction:column;align-items:stretch}
    .title{font-size:34px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">Pink Sky Checker</div>

    <div class="card" role="main" aria-labelledby="title">
      <div class="lead">Pick a location and a day ‚Äî quick verdict + a single Photo-ready score (1‚Äì10).</div>

      <label for="locInput">Location</label>
      <div class="controls" id="controlsRow">
        <button id="useLoc" class="btn" aria-label="Use my location">Use my location</button>
        <input id="locInput" placeholder="Type a city, neighborhood or ZIP (e.g. Chevy Chase, MD)" />
        <select id="daySelect" title="Choose day" aria-label="Choose day"></select>
      </div>

      <div style="margin-top:12px">
        <button id="checkBtn" class="btn large" aria-label="Check sunset conditions">Check</button>
      </div>

      <div id="output" class="result" style="display:none" aria-live="polite"></div>

      <div id="tipsBox" class="tips" style="display:none"></div>
    </div>

    <footer>Made with soft gradients and stubborn optimism ‚òÅÔ∏è</footer>
  </div>

<script>
/* ------------------ Utilities & storage ------------------ */
const STORAGE = 'pinksky_location_v1';

function saveLocation(label, lat, lon){
  try{ localStorage.setItem(STORAGE, JSON.stringify({label,lat,lon})); }
  catch(e){ console.warn('save fail',e); }
}
function loadLocation(){
  try{ const s = localStorage.getItem(STORAGE); return s? JSON.parse(s) : null; } catch(e){ return null; }
}
function dayLabel(d){
  const today = new Date(), dd = new Date(today.getFullYear(), today.getMonth(), today.getDate()+d);
  const opts = {month:'numeric', day:'numeric'};
  if(d===0) return `Today (${dd.toLocaleDateString(undefined,opts)})`;
  if(d===1) return `Tomorrow (${dd.toLocaleDateString(undefined,opts)})`;
  return `${dd.toLocaleDateString(undefined,{weekday:'short',month:'numeric',day:'numeric'})}`;
}
function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }

/* ------------------ UI setup ------------------ */
const locInput = document.getElementById('locInput');
const useLocBtn = document.getElementById('useLoc');
const daySelect = document.getElementById('daySelect');
const checkBtn = document.getElementById('checkBtn');
const output = document.getElementById('output');
const tipsBox = document.getElementById('tipsBox');

(function populateDays(){
  for(let i=0;i<7;i++){
    const o = document.createElement('option'); o.value = i; o.textContent = dayLabel(i); daySelect.appendChild(o);
  }
})();

(function restoreSaved(){
  const s = loadLocation();
  if(s) locInput.value = s.label || '';
})();

/* ------------------ Geocoding helpers (Nominatim) ------------------ */
async function geocodePlace(q){
  const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q);
  try{
    const r = await fetch(url, {headers:{'Accept-Language':'en'}});
    const j = await r.json();
    if(j && j[0]) return {lat:+j[0].lat, lon:+j[0].lon, label: j[0].display_name};
  }catch(e){ console.warn('geocode fail',e); }
  return null;
}
async function reverseGeocode(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`;
  try{
    const r = await fetch(url, {headers:{'Accept-Language':'en'}});
    const j = await r.json();
    if(j && j.address){
      const a=j.address;
      const city = a.city || a.town || a.village || a.county || '';
      const state = a.state || a.region || '';
      const postcode = a.postcode ? (' ' + a.postcode) : '';
      const label = (city ? city + (state ? ', ' + state : '') : (j.display_name || 'Your location')) + postcode;
      return {label};
    }
  }catch(e){ console.warn('reverse fail', e); }
  return null;
}

/* ------------------ Open-Meteo fetch & scoring ------------------ */
function buildOpenMeteoUrls(lat, lon){
  // Try richer hourly fields first, fallback to simpler
  const base = (f) => `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&timezone=auto&daily=sunrise,sunset&hourly=${f}`;
  return [
    base('cloudcover,cloudcover_high,cloudcover_mid,cloudcover_low,pm2_5'),
    base('cloudcover,pm2_5'),
    base('cloudcover')
  ];
}
async function fetchForecast(lat, lon){
  const urls = buildOpenMeteoUrls(lat,lon);
  for(const u of urls){
    try{
      const r = await fetch(u);
      const j = await r.json();
      // minimal validation
      if(j && j.hourly && j.hourly.time && j.daily && j.daily.sunset) return j;
    }catch(e){ console.warn('open-meteo fail',e); }
  }
  return null;
}

/* find hour index nearest to target date/time */
function nearestHourIndex(timesISO, targetDate){
  let bestIdx=0, best=1e18;
  for(let i=0;i<timesISO.length;i++){
    const d = Math.abs(new Date(timesISO[i]).getTime() - targetDate.getTime());
    if(d < best){ best = d; bestIdx = i; }
  }
  return bestIdx;
}

/* scoring: convert internal heuristic to 1..10 scale */
function computeScoreAndReason(hour, values){
  // values may include cloudcover, cloudcover_high/mid/low, pm2_5
  let score = 0;
  // heuristics tuned for colorful afterglow:
  // thin high/mid clouds help (scatter red light), low thick clouds hurt
  if(values.cloudcover_high!=null){
    if(values.cloudcover_high >= 15 && values.cloudcover_high <= 85) score += 2;
    else if(values.cloudcover_high > 85) score -= 1;
  }
  if(values.cloudcover_mid!=null){
    if(values.cloudcover_mid >= 10 && values.cloudcover_mid <= 80) score += 1.5;
    else if(values.cloudcover_mid > 80) score -= 1;
  }
  if(values.cloudcover_low!=null){
    if(values.cloudcover_low <= 30) score += 1;
    else score -= 1.5;
  }
  if(values.cloudcover!=null){
    if(values.cloudcover === 0) score -= 0.6;
    else if(values.cloudcover > 90) score -= 1.2;
    else if(values.cloudcover >= 10 && values.cloudcover <= 80) score += 1;
  }
  if(values.pm2_5!=null){
    if(values.pm2_5 <= 12) score += 1;
    else if(values.pm2_5 <= 35) score += 0.2;
    else score -= 1.2;
  }

  // convert to 1-10
  // map possible -3..7 range into 1..10
  const min=-3, max=7;
  const clamped = clamp(score, min, max);
  const pct = (clamped - min) / (max - min);
  const scale = Math.round(1 + pct * 9);

  // produce short human verdict
  let verdict = 'Unlikely to be vivid';
  let reason = 'Not favorable clouds';
  if(score >= 4) { verdict = 'Great chance of vivid colors'; reason = 'Thin high/mid clouds at good levels'; }
  else if(score >= 1.5) { verdict = 'Possible ‚Äî might catch color'; reason = 'Some thin clouds at useful levels'; }
  else { // negative
    if(values.cloudcover_low && values.cloudcover_low > 50) { reason = 'Low, thick clouds'; }
    else if(values.cloudcover && values.cloudcover > 90) reason = 'Widespread overcast';
    else if(values.pm2_5 && values.pm2_5 > 35) reason = 'Reduced visibility / haze';
  }

  return {scale, verdict, reason};
}

/* ------------------ UI rendering ------------------ */
function showMessage(html){
  output.style.display='block';
  output.innerHTML = html;
  tipsBox.style.display = 'none';
}
function showResult({label, sunset, bestCheck, rating, verdict, reason, detailsArr}){
  output.style.display='block';
  const pillColor = ratingColor(rating);
  const details = detailsArr.length? detailsArr.join(' ¬∑ '): '';
  output.innerHTML = `
    <div class="score-row">
      <div class="score-left">
        <div class="score-title">Photo-ready</div>
        <div class="verdict">${verdict}</div>
        <div class="tagline">${reason} ¬∑ Best check ${bestCheck}</div>
      </div>
      <div style="text-align:right">
        <div class="pill" style="background:${pillColor}">${rating}</div>
      </div>
    </div>
    <div class="details">${details}</div>
    <div class="details" style="margin-top:8px">Location: <strong>${label}</strong> ¬∑ Sunset: ${sunset}</div>
  `;
  tipsBox.style.display='block';
  tipsBox.innerHTML = `<strong>Photo tip:</strong> arrive at ${bestCheck}. Tap focus on your phone, lower exposure a touch, use Live Photo or burst. <br><br><a id="icsLink" href="#" style="color:#243046;text-decoration:underline">üìÖ Add reminder</a>`;
}

/* pick a pleasing pill color based on rating */
function ratingColor(n){
  // gradient between pink (1) and blue (10)
  const t = (n - 1) / 9;
  const r = Math.round(255 + (110 - 255)*t);
  const g = Math.round(120 + (155 - 120)*t);
  const b = Math.round(182 + (255 - 182)*t);
  return `rgb(${r},${g},${b})`;
}

/* create a small .ics blob for the calendar reminder */
function makeICS(dt){
  function pad(n){ return String(n).padStart(2,'0'); }
  function toICS(d){
    return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'Z';
  }
  const start = toICS(dt);
  const end = toICS(new Date(dt.getTime()+20*60000));
  const uid = 'pinksky-' + Date.now() + '@local';
  return [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//pink-sky//EN',
    'BEGIN:VEVENT',
    `UID:${uid}`,
    `DTSTAMP:${start}`,
    `DTSTART:${start}`,
    `DTEND:${end}`,
    'SUMMARY:Pink Sky check',
    'DESCRIPTION:Quick check for colorful afterglow.',
    'END:VEVENT','END:VCALENDAR'
  ].join('\n');
}

/* ------------------ Main check flow ------------------ */
async function performCheckWithCoords(lat, lon, label){
  showMessage('Checking forecast‚Ä¶');

  const json = await fetchForecast(lat, lon);
  if(!json){ showMessage('<div style="color:var(--pink);font-weight:800">Forecast unavailable for that spot.</div>'); return; }

  const dayIndex = parseInt(daySelect.value || '0', 10);
  // get sunset for that day
  if(!json.daily || !json.daily.sunset || dayIndex >= json.daily.sunset.length){
    showMessage('<div style="color:var(--pink);font-weight:800">No forecast for that day. Try a nearer day.</div>');
    return;
  }
  const sunsetISO = json.daily.sunset[dayIndex];
  const sunsetDate = new Date(sunsetISO);
  // find nearest hour in hourly arrays
  const times = json.hourly.time;
  const idx = nearestHourIndex(times, sunsetDate);

  const values = {};
  const h = json.hourly;
  if(h.cloudcover) values.cloudcover = h.cloudcover[idx];
  if(h.cloudcover_high) values.cloudcover_high = h.cloudcover_high[idx];
  if(h.cloudcover_mid) values.cloudcover_mid = h.cloudcover_mid[idx];
  if(h.cloudcover_low) values.cloudcover_low = h.cloudcover_low[idx];
  if(h.pm2_5) values.pm2_5 = h.pm2_5[idx];

  const details = [];
  if(values.cloudcover!=null) details.push(`Cloud ${Math.round(values.cloudcover)}%`);
  if(values.cloudcover_high!=null) details.push(`High ${Math.round(values.cloudcover_high)}%`);
  if(values.cloudcover_mid!=null) details.push(`Mid ${Math.round(values.cloudcover_mid)}%`);
  if(values.cloudcover_low!=null) details.push(`Low ${Math.round(values.cloudcover_low)}%`);
  if(values.pm2_5!=null){
    const labelAQ = values.pm2_5 <= 12 ? 'Good' : values.pm2_5 <=35 ? 'Moderate' : 'Poor';
    details.push(`AQ: ${labelAQ}`);
  }

  const {scale, verdict, reason} = computeScoreAndReason(sunsetDate, values);
  // best check ~10 minutes after sunset
  const best = new Date(sunsetDate.getTime() + 10*60000);
  const sunsetStr = sunsetDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const bestStr = best.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  showResult({label, sunset: sunsetStr, bestCheck: bestStr, rating: scale, verdict, reason, detailsArr: details});

  // add ICS link
  const ics = makeICS(best);
  const blob = new Blob([ics], {type:'text/calendar'});
  const url = URL.createObjectURL(blob);
  const a = document.getElementById('icsLink');
  if(a){ a.href = url; a.download = 'pink-sky-check.ics'; }
  // save location
  saveLocation(label, lat, lon);
}

/* ------------------ event handlers ------------------ */
checkBtn.addEventListener('click', async ()=>{
  const typed = locInput.value.trim();
  if(!typed){
    // if no typed value, try saved
    const saved = loadLocation();
    if(saved && saved.lat && saved.lon){
      await performCheckWithCoords(saved.lat, saved.lon, saved.label || 'Saved location');
      return;
    } else {
      alert('Type a city/neighborhood or tap "Use my location".');
      return;
    }
  }
  // geocode typed value
  showMessage('Resolving location‚Ä¶');
  const res = await geocodePlace(typed);
  if(!res){ showMessage('<div style="color:var(--pink);font-weight:800">Could not find that place. Try "Chevy Chase, MD".</div>'); return; }
  // keep label shortish (city, state, zip)
  const label = (res.label || typed).split(',').slice(0,3).join(', ');
  locInput.value = label;
  await performCheckWithCoords(res.lat, res.lon, label);
});

useLocBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  showMessage('Locating‚Ä¶ (allow location in the browser)');
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    const rev = await reverseGeocode(lat, lon);
    const label = rev && rev.label ? rev.label : 'Your location';
    locInput.value = label;
    await performCheckWithCoords(lat, lon, label);
  }, (err)=>{
    showMessage('<div style="color:var(--pink);font-weight:800">Location failed/denied. Type your city or neighborhood instead.</div>');
    console.warn('geoloc fail', err);
  }, {timeout:10000});
});

</script>
</body>
</html>
