<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pink Sky Checker</title>
<style>
  :root{
    --bg-top:#eaf6ff;
    --bg-bottom:#fff4fb;
    --card:#ffffff;
    --ink:#071425;
    --muted:#6b7280;
    --low:#ff8fbf;
    --mid:#b08bff;
    --high:#6e9bff;
    --shadow: 0 12px 34px rgba(8,18,40,0.08);
  }
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));
    color:var(--ink); -webkit-font-smoothing:antialiased;
    padding:30px 16px;
  }

  /* decorative clouds (visible, behind content) */
  .clouds{position:fixed;left:0;right:0;top:0;bottom:0;pointer-events:none;z-index:0;opacity:.22;filter: blur(8px) saturate(.98);}
  .clouds svg{width:40%;max-width:520px;opacity:.95}

  /* title: outside card, bubble-ish 90s feel via gradient text & heavy layered shadows */
  .title-wrap{max-width:760px;margin:0 auto 18px;position:relative;z-index:2;}
  .title{
    font-weight:900;font-size:36px;letter-spacing:-0.02em;
    color:transparent;
    background-image: linear-gradient(90deg,var(--low),var(--mid),var(--high));
    -webkit-background-clip:text;background-clip:text;
    text-shadow:
      0 3px 0 rgba(255,255,255,0.8),
      0 6px 18px rgba(106,90,205,0.10),
      0 12px 30px rgba(107,119,255,0.08);
    display:inline-block;padding:6px 14px;border-radius:18px;
  }

  /* card */
  .card{max-width:760px;margin:12px auto;padding:16px;border-radius:14px;background:var(--card);box-shadow:var(--shadow);position:relative;z-index:2}
  .lead{color:var(--muted);margin-bottom:10px;font-size:15px}
  label{display:block;margin:8px 0 6px;font-weight:700;color:var(--ink);font-size:14px}

  input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(99,102,241,0.06);font-size:15px}
  .row{display:flex;gap:10px;align-items:center}
  .btn{padding:12px;border-radius:12px;border:0;color:white;font-weight:800;cursor:pointer;background:linear-gradient(90deg,var(--low),var(--mid),var(--high));box-shadow:0 8px 22px rgba(107,119,255,0.12)}
  select{padding:10px;border-radius:10px;border:1px solid rgba(99,102,241,0.06);background:white;font-size:15px}

  /* result area ‚Äî compact & clear */
  .result{margin-top:14px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(245,251,255,0.85), rgba(255,248,252,0.85));border:1px solid rgba(99,102,241,0.05);font-size:15px}
  .score-row{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  .score-big{font-weight:900;font-size:28px}
  .score-pill{padding:8px 12px;border-radius:999px;color:white;font-weight:800;min-width:72px;text-align:center}
  /* gradient for the pill will be set inline to reflect value */
  .verdict-short{font-weight:800;margin-top:6px}
  .tagline{color:var(--muted);font-size:13px;margin-top:6px}

  .details{color:var(--muted);margin-top:10px;font-size:14px}
  .tiny{font-size:12px;color:var(--muted);margin-top:8px}

  @media(max-width:720px){
    .row{flex-direction:column;align-items:stretch}
    .btn{width:100%}
    .title{font-size:30px}
    .score-big{font-size:22px}
  }
  footer{max-width:760px;margin:18px auto 60px;color:var(--muted);text-align:center;font-size:13px;position:relative;z-index:2}
</style>
</head>
<body>

  <!-- visible fluffy clouds -->
  <div class="clouds" aria-hidden="true">
    <svg style="position:absolute;left:-10%;top:2%;" viewBox="0 0 600 150" xmlns="http://www.w3.org/2000/svg"><g fill="#fff"><ellipse cx="140" cy="80" rx="140" ry="44"/><ellipse cx="320" cy="70" rx="80" ry="34"/><ellipse cx="460" cy="78" rx="110" ry="40"/></g></svg>
    <svg style="position:absolute;right:-8%;top:140px;" viewBox="0 0 600 150" xmlns="http://www.w3.org/2000/svg"><g fill="#fff"><ellipse cx="120" cy="70" rx="120" ry="40"/><ellipse cx="260" cy="58" rx="90" ry="34"/><ellipse cx="420" cy="66" rx="110" ry="36"/></g></svg>
    <svg style="position:absolute;left:5%;bottom:-30px;" viewBox="0 0 600 150" xmlns="http://www.w3.org/2000/svg"><g fill="#fff"><ellipse cx="150" cy="70" rx="150" ry="48"/><ellipse cx="350" cy="60" rx="90" ry="36"/></g></svg>
  </div>

  <div class="title-wrap"><div class="title">Pink Sky Checker</div></div>

  <div class="card" role="main" aria-labelledby="title">
    <div class="lead">Pick a spot and day. The app gives a short verdict and a single Photo-ready score (1‚Äì10) so you can decide fast.</div>

    <label for="manual">Location</label>
    <div class="row">
      <button id="btnGeo" class="btn" aria-label="Use my location">Use my location</button>
      <input id="manual" placeholder="Chevy Chase, MD or 38.96,-77.09" aria-label="Location input" />
      <select id="daySelect" title="Choose day"></select>
    </div>

    <div style="margin-top:12px">
      <button id="btnCheck" class="btn" style="width:100%">Check</button>
    </div>

    <div id="output" class="result" style="display:none" role="status" aria-live="polite"></div>

    <div id="after" style="display:none">
      <div class="details" id="tips" style="display:none"></div>
      <div class="tiny" id="notes" style="display:none"></div>
    </div>
  </div>

  <footer>Made with soft clouds and stubborn optimism ‚òÅÔ∏è</footer>

<script>
/* ---------------- logic (keeps the forecasting & storage behavior) ---------------- */
const STORAGE_KEY='pinksky_saved_location';
function saveLocationToStorage(name,lat,lon){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({name,lat,lon})); }catch(e){console.warn(e)} }
function loadLocationFromStorage(){ try{ const s=localStorage.getItem(STORAGE_KEY); if(!s) return null; const o=JSON.parse(s); if(o && typeof o.lat==='number'&&typeof o.lon==='number') return o;}catch(e){console.warn(e)} return null; }

function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function weekdayShort(d){ return d.toLocaleDateString(undefined,{weekday:'short'}); }
function md(d){ return (d.getMonth()+1)+'/'+d.getDate(); }
function populateDaySelect(){ const sel=document.getElementById('daySelect'); sel.innerHTML=''; const now=new Date(); for(let i=0;i<7;i++){ const dt=addDays(now,i); const label=(i===0?'Today':(i===1?'Tomorrow':weekdayShort(dt)))+' ('+md(dt)+')'; const o=document.createElement('option'); o.value=''+i; o.textContent=label; sel.appendChild(o);} }
populateDaySelect();

function nearestIndex(timesISO,targetDate){ let best=0,bestD=1e12; for(let i=0;i<timesISO.length;i++){ const d=Math.abs(new Date(timesISO[i]).getTime()-targetDate.getTime()); if(d<bestD){bestD=d;best=i}} return best; }

function buildUrls(lat,lon){ const base=f=>`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=sunrise,sunset&hourly=${f}&timezone=auto`; return [base('cloudcover,cloudcover_high,cloudcover_mid,cloudcover_low,pm2_5'), base('cloudcover,pm2_5'), base('cloudcover')]; }
async function tryFetchUrls(urls){ for(const u of urls){ try{ const r=await fetch(u); const j=await r.json(); if(j && j.daily && j.hourly && j.hourly.time && j.hourly.time.length){ if(j.hourly.cloudcover || j.hourly.cloudcover===0) return j; } }catch(e){console.warn(e)} } return null; }

/* mapping old numeric score into 1-10 for photo-ready */
function scoreToScale(score){
  // clamp roughly -2 .. +6
  const min=-2, max=6;
  const s=Math.max(min, Math.min(max, score));
  const pct=(s-min)/(max-min); // 0..1
  return Math.round(1 + pct*9); // 1..10
}
function scaleColor(n){
  // 1->pink, 10->blue via linear interpolation
  const t=(n-1)/9;
  // interpolate rgb for pink (#ff8fbf) to blue (#6e9bff)
  const a=[255,143,191], b=[110,155,255];
  const r=Math.round(a[0]+(b[0]-a[0])*t), g=Math.round(a[1]+(b[1]-a[1])*t), bl=Math.round(a[2]+(b[2]-a[2])*t);
  return `rgb(${r},${g},${bl})`;
}

/* small AQ label */
function airQualityLabel(pm2){
  if(pm2==null) return null;
  if(pm2 <= 12) return 'Good';
  if(pm2 <= 35) return 'Moderate';
  return 'Poor';
}

/* geocode (accept lat,lons or use nominatim), but reuse saved name to avoid repeat */
async function fetchCoordsFromText(text){
  const latlon = text.match(/(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/);
  if(latlon) return {lat:+latlon[1], lon:+latlon[2], name:`${+latlon[1].toFixed(4)},${+latlon[2].toFixed(4)}`};
  const saved = loadLocationFromStorage();
  if(saved && saved.name===text) return {lat:saved.lat, lon:saved.lon, name:saved.name};
  try{
    const q=encodeURIComponent(text);
    const url=`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=1`;
    const r=await fetch(url,{headers:{'Accept-Language':'en'}});
    const j=await r.json();
    if(j && j[0]) return {lat:+j[0].lat, lon:+j[0].lon, name:j[0].display_name};
  }catch(e){console.warn(e)}
  return null;
}

/* main check: fetch forecast, compute score, show compact UI */
async function check(lat,lon,displayName){
  const out=document.getElementById('output'); out.style.display='block'; out.textContent='Checking forecast‚Ä¶'; document.getElementById('after').style.display='none';
  try{
    const urls=buildUrls(lat,lon);
    const json=await tryFetchUrls(urls);
    if(!json){ out.innerHTML=`<div style="color:#ff6fb5;font-weight:800">Forecast unavailable for that spot.</div>`; return; }
    const dayIndex=parseInt(document.getElementById('daySelect').value||'0',10);
    if(!json.daily || !json.daily.sunset || dayIndex>=json.daily.sunset.length){ out.innerHTML=`<div style="color:#ff6fb5;font-weight:800">No forecast for that day. Try a nearer day.</div>`; return; }

    // save location for reuse
    const nameToSave = displayName || document.getElementById('manual').value.trim() || `${lat.toFixed(4)},${lon.toFixed(4)}`;
    saveLocationToStorage(nameToSave, lat, lon);

    const sunsetLocal = new Date(json.daily.sunset[dayIndex]);
    const times = json.hourly.time;
    const idx = nearestIndex(times, sunsetLocal);

    const cloud = json.hourly.cloudcover ? json.hourly.cloudcover[idx] : null;
    const chigh = json.hourly.cloudcover_high ? json.hourly.cloudcover_high[idx] : null;
    const cmid = json.hourly.cloudcover_mid ? json.hourly.cloudcover_mid[idx] : null;
    const clow = json.hourly.cloudcover_low ? json.hourly.cloudcover_low[idx] : null;
    const pm2 = json.hourly.pm2_5 ? json.hourly.pm2_5[idx] : null;

    // scoring (same as previous)
    let score = 0;
    if (chigh !== null) { if (chigh >= 15 && chigh <= 85) score += 2; else if (chigh > 85) score -= 1; else score += 0.5; }
    if (cmid !== null) { if (cmid >= 10 && cmid <= 80) score += 1.5; else if (cmid > 80) score -= 1; }
    if (clow !== null) { if (clow <= 30) score += 1; else score -= 1.5; }
    if (cloud !== null) { if (cloud >= 10 && cloud <= 80) score += 1; else if (cloud === 0) score -= 0.8; else if (cloud > 90) score -= 1.2; }
    if (pm2 !== null) { if (pm2 <= 12) score += 1.2; else if (pm2 <= 35) score += 0.2; else score -= 1.2; }

    // compact verdict text (short)
    let shortText=''; let reason='';
    if (score >= 4) { shortText='Great chance of vivid colors'; reason='Thin clouds at good altitudes'; }
    else if (score >= 1.5) { shortText='Possible ‚Äî might catch color'; reason='Thin high/mid clouds present'; }
    else { shortText='Unlikely to be vivid'; reason = (clow!==null && clow>50)?'Thick low clouds': (cloud!==null && cloud>90)?'Widespread overcast': (pm2!==null && pm2>35)?'Reduced visibility/haze':'Not favorable clouds'; }

    const best = new Date(sunsetLocal.getTime() + 10*60000);
    const rating = scoreToScale(score);
    const pillColor = scaleColor(rating);
    const details = [];
    if (cloud !== null) details.push(`Cloud ${Math.round(cloud)}%`);
    if (chigh !== null) details.push(`High ${Math.round(chigh)}%`);
    if (cmid !== null) details.push(`Mid ${Math.round(cmid)}%`);
    if (clow !== null) details.push(`Low ${Math.round(clow)}%`);
    if (pm2 !== null) details.push(`AQ: ${airQualityLabel(pm2)}`);

    // render compact UI
    out.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px" class="score-row">
        <div>
          <div class="score-big">Photo-ready</div>
          <div class="verdict-short" style="margin-top:6px;font-weight:800">${shortText}</div>
          <div class="tagline">${reason} ¬∑ Best check ${best.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
        </div>
        <div style="text-align:right">
          <div class="score-big" style="font-size:28px">${rating}/10</div>
          <div class="score-pill" style="background:${pillColor}">${rating}</div>
        </div>
      </div>
      <div class="details">${details.join(' ¬∑ ')}</div>
      <div class="tiny">Sunset: ${sunsetLocal.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
    `;

    // tips + ICS
    document.getElementById('after').style.display='block';
    document.getElementById('tips').style.display='block';
    document.getElementById('tips').innerHTML = `<strong>Photo tip:</strong> arrive at ${best.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}. Tap focus, lower exposure a touch, use Live Photo/burst.`;
    document.getElementById('notes').style.display='block';
    document.getElementById('notes').textContent = 'Score is 1‚Äì10 photo-readiness (1 = unlikely, 10 = very likely).';

    const ics = makeICS(best);
    const blob = new Blob([ics], {type:'text/calendar'});
    const urlBlob = URL.createObjectURL(blob);
    // add ICS link inside tips
    const icsLink = document.createElement('a');
    icsLink.href = urlBlob;
    icsLink.download = 'pink-sky-reminder.ics';
    icsLink.className='tiny';
    icsLink.style.display='inline-block';
    icsLink.style.marginTop='6px';
    icsLink.textContent='üìÖ Add reminder';
    document.getElementById('tips').appendChild(document.createElement('br'));
    document.getElementById('tips').appendChild(icsLink);

  }catch(err){
    console.error(err);
    out.innerHTML = `<div style="color:var(--low);font-weight:800">Error fetching forecast ‚Äî check internet and try again.</div>`;
  }
}

/* wiring: check button & geolocation & saved name */
async function onCheckClicked(){
  const v = document.getElementById('manual').value.trim();
  if(!v) return alert('Type a city or coordinates, or press "Use my location".');
  const saved = loadLocationFromStorage();
  const latlonRegex = /(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/;
  const latlon = v.match(latlonRegex);
  if(latlon){ return await check(+latlon[1], +latlon[2], `${+latlon[1].toFixed(4)},${+latlon[2].toFixed(4)}`); }
  else if(saved && saved.name===v){ return await check(saved.lat, saved.lon, saved.name); }
  else{
    document.getElementById('output').style.display='block'; document.getElementById('output').textContent='Resolving location‚Ä¶';
    const coords = await fetchCoordsFromText(v);
    if(!coords){ document.getElementById('output').innerHTML=`<div style="color:var(--low);font-weight:800">Could not resolve that location. Try "Chevy Chase, MD" or coordinates.</div>`; return; }
    document.getElementById('manual').value = coords.name;
    await check(coords.lat, coords.lon, coords.name);
  }
}
document.getElementById('btnCheck').addEventListener('click', onCheckClicked);

document.getElementById('btnGeo').addEventListener('click', async ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  document.getElementById('output').style.display='block'; document.getElementById('output').textContent='Locating‚Ä¶';
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    const displayName = `${lat.toFixed(4)},${lon.toFixed(4)}`;
    document.getElementById('manual').value = displayName;
    await check(lat, lon, displayName);
  }, (err)=>{
    alert('Location denied/failed. You can type your city or coords instead.'); console.warn(err); document.getElementById('output').style.display='none';
  }, {timeout:10000});
});

/* prefill saved name on load */
window.addEventListener('DOMContentLoaded', ()=>{
  const saved = loadLocationFromStorage();
  if(saved) document.getElementById('manual').value = saved.name;
});

/* ICS helper */
function makeICS(dt){
  function toUTCICS(d){ const pad=n=>String(n).padStart(2,'0'); return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'Z'; }
  const start=toUTCICS(dt); const end=toUTCICS(new Date(dt.getTime()+20*60000));
  const uid='pink-sky-'+Date.now()+'@local'; const summary='Pink-sky check'; const body='Sunset +10 minutes ‚Äî check for colorful afterglow.';
  return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//pink-sky//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${start}
DTSTART:${start}
DTEND:${end}
SUMMARY:${summary}
DESCRIPTION:${body}
END:VEVENT
END:VCALENDAR`;
}
</script>
</body>
</html>